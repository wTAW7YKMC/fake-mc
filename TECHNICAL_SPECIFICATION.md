# 技术规格文档

## 1. 核心体素系统（Voxel System）

### 1.1 体素定义

基础单元为 "1x1x1 立方米体素（Voxel Unit）"，具备唯一 ID（Block ID）和元数据（Metadata，如朝向、状态）。

### 1.2 体素分类

#### 固体体素（Solid Voxel）
- 示例：石头、泥土、木头等
- 具有完整碰撞盒，阻止玩家和其他物体穿过
- 在渲染时完全不透明

#### 非固体体素（Non-solid Voxel）
- 示例：空气、水等
- 无碰撞或半碰撞特性
- 空气完全不影响玩家移动
- 水可能减缓玩家移动速度但不妨碍通行

### 1.3 渲染特性

#### 透明体素（Transparent Voxel）
- 示例：玻璃、树叶等
- 渲染时启用 Alpha 混合，不遮挡全部光线
- 支持透过渲染，可以看到背后的物体

#### 半透明体素（Translucent Voxel）
- 示例：水、岩浆等
- 渲染时启用深度写入但半透
- 具有特殊的光学特性，影响周围光照

### 1.4 数据结构

```javascript
// 体素基本结构
const Voxel = {
  id: 0,           // 唯一标识符 Block ID
  name: "",        // 名称
  type: "",        // 类型：solid, nonsolid, transparent, translucent
  metadata: {},    // 元数据：朝向、状态等
  texture: ""      // 纹理信息
};

// 世界数据结构
const World = {
  chunks: [],      // 区块数据
  voxels: {}       // 体素定义映射
};
```

### 1.5 碰撞检测

根据不同类型的体素实施相应的碰撞检测策略：
- 固体体素：完全阻挡玩家移动
- 非固体体素：允许玩家穿过
- 特殊体素（如水）：影响玩家移动速度但不完全阻挡

### 1.6 渲染管线

根据体素类型采用不同的渲染策略：
1. 不透明体素：正常渲染，按从后往前顺序
2. 透明体素：启用 Alpha 混合，按从前往后顺序
3. 半透明体素：启用深度写入，特殊处理光照效果

## 2. 3D 渲染系统（Rendering Pipeline）

### 2.1 基础渲染模式

- **透视投影（Perspective Projection）**：视场角（FOV）设为 70°±5°（匹配 Minecraft 视角广度），近平面（Near Plane）0.1 米，远平面（Far Plane）256 米（基于视距动态调整）
- **禁用正交投影（Orthographic Projection）**：解决当前平面问题
- **启用深度测试（Depth Testing）和模板测试（Stencil Testing）**：避免渲染顺序错误

### 2.2 体素网格生成

- **六面网格（6-Face Mesh）**：每个体素自动生成六面网格
- **背面剔除（Backface Culling）**：优化渲染性能
- **相邻面合并（Adjacent Face Merging）**：若某一面与相邻体素接触，自动剔除该面（减少多边形数量）
- **网格数据存储**：顶点缓冲对象（VBO）和索引缓冲对象（IBO）
- **实例化渲染（Instanced Rendering）**：批量绘制同类型体素（降低 Draw Call）

### 2.3 纹理与材质

- **纹理图集（Texture Atlas）**：整合所有方块纹理（单张图集尺寸 256x256 或 512x512 像素），通过 UV 坐标映射到体素面（避免纹理重复加载）
- **纹理过滤（Texture Filtering）**：
  - 近处：双线性过滤（Bilinear Filtering）
  - 远处：三线性过滤（Trilinear Filtering）+ 各向异性过滤（Anisotropic Filtering），避免纹理模糊
- **材质属性**：
  - 金属方块：启用镜面反射（Specular Reflection）
  - 水方块：启用反射/折射（Reflection/Refraction）效果

### 2.4 光照与阴影

- **基础光照模型**：
  - 环境光（Ambient Light）：强度 0.2-0.3
  - 定向光（Directional Light）：模拟太阳，强度 0.7-0.8，方向随时间动态变化
- **体素光照计算**：采用光照传播算法（Light Propagation Algorithm）
  - 每个体素存储光照等级（0-15 级，15 级最亮）
  - 光源体素（如火把、太阳）向周围传播光照
  - 透明体素允许部分光照穿透
- **简化阴影**：启用方块阴影贴图（Block Shadow Mapping），仅渲染实体（玩家、生物）的硬阴影，体素自身不产生阴影（优化性能）

### 2.5 视觉增强

- **天空盒（Skybox）**：动态切换日出/正午/日落/夜晚纹理，匹配时间系统
- **雾效（Fog）**：远处区块添加线性雾（Linear Fog），雾色随天空盒变化（增强深度感）
- **实体渲染**：
  - 玩家手臂、工具、掉落物：采用 Billboard 渲染（始终面向相机）
  - 生物：采用骨骼动画（Skeletal Animation）

## 3. 世界生成系统（World Generation）

### 3.1 基础框架

- **种子（Seed）**：基于 64 位整数生成确定性世界（同一种子生成完全相同的世界）
- **区块（Chunk）**：标准尺寸 16x256x16 体素（X 轴 16、Y 轴 256、Z 轴 16），区块坐标以（ChunkX, ChunkZ）标识

### 3.2 地形生成逻辑

- **核心算法**：Perlin 噪声（Perlin Noise）+ 多层噪声叠加
  - 第一层噪声：生成高度图（Heightmap），控制地形整体起伏（平原、山地）
  - 第二层噪声：生成粗糙度（Roughness），添加局部细节（小山坡、凹陷）
  - 第三层噪声：生成生物群系掩码（Biome Mask），划分生物群系区域
- **高度范围**：Y 轴 0-255（0 为基岩，255 为世界顶部），海平面设为 Y=63

### 3.3 生物群系（Biomes）

- **基础生物群系**（至少实现 5 种）：
  - 草原（Grassland）：多草方块 + 少量树
  - 森林（Forest）：多橡树 + 落叶
  - 沙漠（Desert）：多沙方块 + 仙人掌
  - 山脉（Mountain）：多石头 + 雪
  - 海洋（Ocean）：Y<63 全为水
- **生物群系属性**：定义该区域的方块分布、植被概率、光照强度、温度（影响积雪生成）

### 3.4 结构生成

- **自然结构**：
  - 树木：通过 L 系统（L-System）生成（树干高度、分支角度随机）
  - 洞穴：通过噪声阈值生成（Y<60 区域，噪声值低于阈值则替换为空气）
- **人造结构**：随机生成小建筑（如木屋、矿井），通过结构模板（Structure Template，预定义体素坐标集合）在指定生物群系生成

### 3.5 区块管理

- **以玩家为中心的径向加载（Player-Centric Radial Loading）**：仅加载玩家周围视距（Render Distance）范围内的区块（默认 8 区块，即 128 米）
- **区块状态**：未生成（Ungenerated）→ 生成中（Generating）→ 加载（Loaded）→ 活跃（Active，玩家附近）→ 卸载（Unloaded，超过视距）
- **区块持久化**：生成的区块数据通过二进制文件（.chunk）或 SQLite 数据库存储，下次加载时直接读取（避免重复生成）

## 4. 物理与碰撞系统（Physics & Collision）

### 4.1 碰撞盒定义

- **玩家碰撞盒**：AABB（轴对齐 bounding box），尺寸 0.6x1.8x0.6 米（宽 x 高 x 深），中心点位于脚部上方 0.9 米（匹配 Minecraft 玩家碰撞体积）
- **体素碰撞盒**：固体体素默认 AABB 为 1x1x1 米（与体素尺寸一致），特殊体素（如台阶、半砖）使用自定义 AABB（如 0.5x0.5x1 米）
- **实体碰撞盒**：掉落物为 0.2x0.2x0.2 米，生物（如猪）为 0.9x0.9x1.3 米

### 4.2 物理规则

- **重力**：加速度 9.8m/s²（垂直向下），玩家下落终端速度设为 5m/s（避免无限加速）
- **移动物理**：
  - 步行速度 4.317m/s，奔跑速度 5.612m/s（按住左 Ctrl 加速），潜行速度 2.7m/s（同时降低碰撞盒高度至 1.5 米）
  - 跳跃初速度 3.15m/s，跳跃高度约 0.5 米，空中移动阻力为地面的 0.8 倍（模拟空中滞空感）
- **碰撞响应**：玩家与固体体素碰撞时，沿碰撞面法线方向抵消速度（避免穿模）；实体间碰撞时，应用动量守恒（如玩家推动物品）

### 4.3 特殊物理效果

- **液体浮力**：玩家进入水/岩浆时，重力减为 0.5 倍，移动速度降为 0.8 倍，并有向上的浮力（Y 轴加速度 + 2m/s²）
- **方块掉落物理**：破坏方块后生成掉落物实体，赋予随机初速度（±0.5m/s），受重力影响下落，落地后静止（碰撞地面时速度归 0）

## 5. 玩家控制器（Player Controller）

### 5.1 视角控制

- **鼠标输入**：
  - 横向移动（X 轴）：控制偏航角（Yaw）（左右转向，0-360°）
  - 纵向移动（Y 轴）：控制俯仰角（Pitch）（上下仰视，-90° 至 90°，避免超过范围导致视角翻转）
- **鼠标灵敏度**：默认 50（可调节），灵敏度 = 像素移动量 ×0.15°/像素（确保转向流畅）
- **相机位置**：固定在玩家碰撞盒中心点上方 0.1 米（模拟眼睛高度）

### 5.2 交互系统

- **射线检测（Raycasting）**：从相机位置发射射线，长度 5 米（交互最大距离），检测与体素的交点（优先检测固体体素）

### 5.3 方块破坏

- **破坏进度条（Breaking Progress Bar）**：射线命中体素时显示，进度随时间增长
  - 增长速率与方块硬度负相关（如木头硬度 2，需 0.5 秒；石头硬度 5，需 1.5 秒）
  - 手持对应工具时加速（如斧头砍木头效率 ×3，镐子敲石头效率 ×3）
  - 进度满时删除目标体素并生成掉落物

### 5.4 方块放置

- **放置位置计算**：射线命中体素表面时，计算命中面外侧 1 米处，检测该位置是否为空气且不与玩家碰撞盒重叠
- **预览虚影（Placement Preview）**：放置时生成半透明显示待放方块，右键确认后生成新体素

### 5.5 物品与背包

- **快捷栏（Hotbar）**：底部 9 个格子，存储可放置/使用物品，数字键 1-9 切换，滚轮循环切换
- **背包（Inventory）**：3x9 主格子 + 4x4 合成格子，按 E 键打开，支持物品拖拽、堆叠（最大堆叠 64 个）
- **手持物品渲染**：第一人称视角下，工具/方块模型渲染在屏幕右下角（手臂 + 物品模型），随视角轻微晃动（模拟手持感）

## 6. UI 与反馈系统（UI & Feedback）

### 6.1 核心 UI 元素

- **十字准星（Crosshair）**：屏幕中心白色像素十字，大小 2x2 像素（瞄准用）
- **状态 HUD**：
  - 生命值：10 颗心（每颗心 = 2 点生命），红色，受伤害时闪烁
  - 饥饿值：10 根鸡腿，黄色，低于 3 根时无法奔跑
  - 经验条：底部绿色进度条，随经验值增长，满后升级
- **交互提示**：方块上方显示名称（如 "橡树原木"），不可交互时准星变为红色

### 6.2 视觉反馈

- **方块破坏动画**：目标体素闪烁（透明度随进度变化），最后碎裂消失
- **受伤反馈**：屏幕边缘变红，伴随轻微抖动
- **跳跃/落地反馈**：跳跃时相机轻微上移，落地时轻微下移（模拟冲击感）

## 7. 性能优化（Performance Optimization）

### 7.1 渲染优化

- **视锥体剔除（Frustum Culling）**：仅渲染相机可见范围内的区块/体素
- **LOD（细节层次）**：远处区块（>128 米）使用简化网格（合并多个体素为一个大网格）
- **纹理压缩**：使用 ETC1/PVRTC 格式压缩纹理图集（减少显存占用）

### 7.2 逻辑优化

- **区块异步生成（Asynchronous Chunk Generation）**：在后台线程生成区块，不阻塞主线程（避免卡顿）
- **实体休眠（Entity Sleeping）**：远离玩家的实体（>64 米）暂停更新逻辑（节省 CPU）

## 8. 其他技术细节

（此处可根据需要添加其他技术规范）